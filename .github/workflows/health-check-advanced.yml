name: ğŸ“Š NFL Scraper Health Check & Monitoring

on:
  schedule:
    # Ejecutar cada 2 horas para monitoreo
    - cron: '0 */2 * * *'
  
  # Permitir ejecuciÃ³n manual
  workflow_dispatch:
    inputs:
      detailed_analysis:
        description: 'Ejecutar anÃ¡lisis detallado de la base de datos'
        required: false
        default: false
        type: boolean

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
  GITHUB_ACTIONS: true
  TZ: 'UTC'

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: ğŸ“š Install minimal dependencies
      run: |
        pip install --upgrade pip
        pip install supabase==1.2.0 python-dotenv==1.0.0
        
    - name: ğŸ” Basic Health Check
      run: |
        echo "ğŸ¥ ===== NFL SCRAPER HEALTH CHECK ====="
        echo "â° Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ”§ Verificando sistema de scraping 24/7..."
        echo "======================================="
        
        # Ejecutar verificaciÃ³n bÃ¡sica (sin Chrome)
        python -c "
        import os
        import sys
        from datetime import datetime
        
        # Verificar variables de entorno
        supabase_url = os.getenv('SUPABASE_URL')
        supabase_key = os.getenv('SUPABASE_KEY')
        
        if not supabase_url or not supabase_key:
            print('âŒ Variables de entorno faltantes')
            sys.exit(1)
        
        print('âœ… Variables de entorno: OK')
        
        # Verificar conexiÃ³n a Supabase
        try:
            from supabase import create_client
            supabase = create_client(supabase_url, supabase_key)
            
            # Test simple query
            response = supabase.table('nfl_fantasy_trends').select('id').limit(1).execute()
            print('âœ… ConexiÃ³n Supabase: OK')
            
            # Contar registros totales
            total_response = supabase.table('nfl_fantasy_trends').select('id').execute()
            total_records = len(total_response.data) if total_response.data else 0
            print(f'ğŸ“Š Total registros en BD: {total_records}')
            
            # Verificar campo semana (nuevo)
            try:
                week_response = supabase.table('nfl_fantasy_trends').select('semana').limit(1).execute()
                print('âœ… Campo semana: DISPONIBLE')
            except Exception as e:
                print('âŒ Campo semana: NO DISPONIBLE')
                print(f'   Error: {e}')
            
        except Exception as e:
            print(f'âŒ Error Supabase: {e}')
            sys.exit(1)
        
        print('ğŸ¥ Health Check: SISTEMA OPERATIVO')
        "
        
    - name: ğŸ“Š Detailed Analysis (if requested)
      if: ${{ github.event.inputs.detailed_analysis == 'true' }}
      run: |
        echo ""
        echo "ğŸ“ˆ ===== ANÃLISIS DETALLADO ====="
        python -c "
        import os
        from supabase import create_client
        from collections import Counter
        from datetime import datetime, timedelta
        
        supabase = create_client(os.getenv('SUPABASE_URL'), os.getenv('SUPABASE_KEY'))
        
        # Obtener todos los registros con timestamps
        response = supabase.table('nfl_fantasy_trends').select('scraped_at, semana').execute()
        data = response.data
        
        if not data:
            print('ğŸ“Š Base de datos vacÃ­a')
            exit()
        
        print(f'ğŸ“Š Total registros analizados: {len(data)}')
        
        # AnÃ¡lisis por timestamp
        timestamps = [record['scraped_at'][:16] for record in data]  # YYYY-MM-DD HH:MM
        timestamp_counts = Counter(timestamps)
        
        print(f'ğŸ“… Sesiones Ãºnicas de scraping: {len(timestamp_counts)}')
        
        # Ãšltimas 5 sesiones
        recent_sessions = sorted(timestamp_counts.items(), reverse=True)[:5]
        print('ğŸ“‹ Ãšltimas 5 sesiones:')
        for ts, count in recent_sessions:
            print(f'   {ts} â†’ {count} registros')
        
        # AnÃ¡lisis por semana (si existe el campo)
        weeks = [record.get('semana') for record in data if record.get('semana')]
        if weeks:
            week_counts = Counter(weeks)
            print(f'ğŸˆ Semanas NFL registradas: {sorted(week_counts.keys())}')
            for week in sorted(week_counts.keys()):
                print(f'   Semana {week}: {week_counts[week]} registros')
        else:
            print('ğŸˆ Sin datos de semanas NFL')
        
        # Verificar actividad reciente (Ãºltimas 2 horas)
        now = datetime.utcnow()
        two_hours_ago = now - timedelta(hours=2)
        
        recent_activity = []
        for ts_str in timestamps:
            try:
                ts = datetime.fromisoformat(ts_str.replace('T', ' '))
                if ts >= two_hours_ago:
                    recent_activity.append(ts_str)
            except:
                continue
        
        print(f'âš¡ Actividad Ãºltimas 2 horas: {len(set(recent_activity))} sesiones')
        if len(set(recent_activity)) == 0:
            print('âš ï¸ Sin actividad reciente - verificar workflow cada 30min')
        else:
            print('âœ… Sistema activo y funcionando')
        "
        
    - name: ğŸ¯ Health Status Summary
      if: always()
      run: |
        echo ""
        echo "ğŸ¯ ===== RESUMEN DE SALUD DEL SISTEMA ====="
        echo "ğŸ“… Ãšltima verificaciÃ³n: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ”„ PrÃ³xima verificaciÃ³n: en 2 horas"
        echo "ğŸˆ Workflow principal: Cada 30 minutos (nfl-scraper-30min)"
        echo "ğŸ“Š Monitoreo: Cada 2 horas (este workflow)"
        echo ""
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… ESTADO GENERAL: SISTEMA SALUDABLE"
          echo "ğŸ’¡ El scraper 24/7 estÃ¡ funcionando correctamente"
        else
          echo "âš ï¸ ESTADO GENERAL: REQUIERE ATENCIÃ“N"
          echo "ğŸ” Revisar logs para identificar problemas"
        fi
        echo "============================================="
